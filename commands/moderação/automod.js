const discord = require("discord.js");
const idioma = require("../../database/models/language");
const GuildConfigLogs = require('../../database/models/auditlogs'); // ImportaÃ§Ã£o correta do modelo de logs

module.exports = {
    name: "automod",
    description: "Configurar sistema automod",
    type: discord.ApplicationCommandType.ChatInput,
    options: [],

    run: async (client, interaction, args) => {
        let lang = await idioma.findOne({
            guildId: interaction.guild.id
        });
        lang = lang ? require(`../../languages/${lang.language}.js`) : require('../../languages/pt.js');

        const { guild } = interaction;

        // VerificaÃ§Ã£o de permissÃµes
        if (!interaction.member.permissions.has(discord.PermissionsBitField.Flags.Administrator)) {
            return await interaction.reply({
                content: `${lang.alertNaoTemPermissÃ£o}`,
                ephemeral: true
            });
        }

        const botMember = interaction.guild.members.cache.get(client.user.id);
        if (!botMember.permissions.has(discord.PermissionFlagsBits.ManageMessages)) {
            return interaction.reply({ content: lang.alertPermissÃ£oBot, ephemeral: true });
        }

        // Verificar se o canal de logs estÃ¡ configurado
        const guildConfigLogs = await GuildConfigLogs.findOne({
            guildId: interaction.guild.id
        });

        let logChannelLogs;
        if (!guildConfigLogs || !guildConfigLogs.canal) {
            return interaction.followUp({
                content: "> \`-\` <a:alerta:1163274838111162499> O canal de logs nÃ£o foi configurado neste servidor. Nenhum log foi gerado. VocÃª pode usar **/audit logs** para configurar um novo canal de logs.",
                ephemeral: true
            });
        } else {
            logChannelLogs = client.channels.cache.get(guildConfigLogs.canal);
            if (!logChannelLogs) {
                return interaction.followUp({
                    content: "> \`-\` <a:alerta:1163274838111162499> O canal de logs configurado foi removido ou estÃ¡ inacessÃ­vel. Nenhum log foi gerado. Use **/audit logs** para configurar um novo canal de logs.",
                    ephemeral: true
                });
            }
        }

        // FunÃ§Ã£o para recriar o menu apÃ³s cada seleÃ§Ã£o
        const createMenu = () => {
            const menu = new discord.StringSelectMenuBuilder()
                .setCustomId('automod-select')
                .setPlaceholder('Selecione uma opÃ§Ã£o de AutoMod')
                .addOptions([
                    {
                        label: 'Bloquear Ofensivas',
                        description: 'Bloqueie palavrÃµes e calÃºnias',
                        value: 'ofensivas',
                    },
                    {
                        label: 'Bloquear Spam de Mensagens',
                        description: 'Bloqueie spam',
                        value: 'spam-mensagens',
                    },
                    {
                        label: 'Limite de MenÃ§Ãµes',
                        description: 'Defina limite de menÃ§Ãµes para bloquear mensagens',
                        value: 'menÃ§Ã£o-spam',
                    },
                    {
                        label: 'Bloquear Palavra-Chave',
                        description: 'Bloqueie uma palavra especÃ­fica',
                        value: 'palavra-chave',
                    },
                ]);
            return new discord.ActionRowBuilder().addComponents(menu);
        };

        // FunÃ§Ã£o para enviar o menu e permitir novas seleÃ§Ãµes
        const sendMenu = async (content) => {
            await interaction.editReply({
                content: content || 'Selecione o tipo de AutoMod que deseja configurar:',
                components: [createMenu()],
                ephemeral: true
            });
        };

        // Enviar o menu interativo inicialmente
        await interaction.reply({
            content: 'Selecione o tipo de AutoMod que deseja configurar:',
            components: [createMenu()],
            ephemeral: true
        });

        // Captura de resposta do menu suspenso
        const filter = i => i.customId === 'automod-select' && i.user.id === interaction.user.id;
        const collector = interaction.channel.createMessageComponentCollector({ filter, time: 60000 });

        collector.on('collect', async i => {
            const selectedOption = i.values[0];

            switch (selectedOption) {
                case 'ofensivas':
                    await i.update({ content: `${lang.msg59}`, components: [] });

                    await guild.autoModerationRules.create({
                        name: `${lang.msg60}`,
                        creatorId: client.user.id,
                        enabled: true,
                        eventType: 1,
                        triggerType: 4,
                        triggerMetadata: { presets: [1, 2, 3] },
                        actions: [
                            {
                                type: 1,
                                metadata: {
                                    channel: interaction.channel,
                                    durationSeconds: 10,
                                    customMessage: `${lang.msg61}`
                                }
                            }
                        ]
                    }).catch(async err => {
                        return await i.followUp({ content: `${lang.msg62}`, ephemeral: true });
                    });

                    const embedOfensivas = new discord.EmbedBuilder()
                        .setColor("#ff0000")
                        .setTitle("ðŸ“‘ AutoMod Ativado: Ofensivas")
                        .setDescription(`${lang.msg60}`)
                        .addFields({ name: "Administrador", value: interaction.user.tag })
                        .setTimestamp();

                    logChannelLogs.send({ embeds: [embedOfensivas] });

                    // Recriar o menu apÃ³s a configuraÃ§Ã£o ser aplicada
                    sendMenu('Selecione outra opÃ§Ã£o de AutoMod que deseja configurar:');
                    break;

                case 'palavra-chave':
                    // Modal para capturar a palavra-chave
                    const palavraModal = new discord.ModalBuilder()
                        .setCustomId('palavra-chave-modal')
                        .setTitle('Bloquear Palavra-Chave')
                        .addComponents(
                            new discord.ActionRowBuilder().addComponents(
                                new discord.TextInputBuilder()
                                    .setCustomId('palavra-chave-input')
                                    .setLabel('Digite a palavra que deseja bloquear:')
                                    .setStyle(discord.TextInputStyle.Short)
                                    .setRequired(true)
                            )
                        );

                    await i.showModal(palavraModal);
                    break;

                case 'spam-mensagens':
                    await i.update({ content: `${lang.msg59}`, components: [] });

                    await guild.autoModerationRules.create({
                        name: `${lang.msg69}`,
                        creatorId: client.user.id,
                        enabled: true,
                        eventType: 1,
                        triggerType: 3,
                        triggerMetadata: {},
                        actions: [
                            {
                                type: 1,
                                metadata: {
                                    channel: interaction.channel,
                                    durationSeconds: 10,
                                    customMessage: `${lang.msg61}`
                                }
                            }
                        ]
                    }).catch(async err => {
                        return await i.followUp({ content: `${lang.msg62}`, ephemeral: true });
                    });

                    const embedSpamMensagens = new discord.EmbedBuilder()
                        .setColor("#ff0000")
                        .setTitle("ðŸ“‘ AutoMod Ativado: Spam de Mensagens")
                        .setDescription(`${lang.msg69}`)
                        .addFields({ name: "Administrador", value: interaction.user.tag })
                        .setTimestamp();

                    logChannelLogs.send({ embeds: [embedSpamMensagens] });

                    // Recriar o menu apÃ³s a configuraÃ§Ã£o ser aplicada
                    sendMenu('Selecione outra opÃ§Ã£o de AutoMod que deseja configurar:');
                    break;

                case 'menÃ§Ã£o-spam':
                    // Modal para capturar o limite de menÃ§Ãµes
                    const mencaoModal = new discord.ModalBuilder()
                        .setCustomId('mencao-spam-modal')
                        .setTitle('Definir Limite de MenÃ§Ãµes')
                        .addComponents(
                            new discord.ActionRowBuilder().addComponents(
                                new discord.TextInputBuilder()
                                    .setCustomId('mencao-spam-input')
                                    .setLabel('Digite o limite de menÃ§Ãµes permitidas:')
                                    .setStyle(discord.TextInputStyle.Short)
                                    .setRequired(true)
                            )
                        );

                    await i.showModal(mencaoModal);
                    break;

                default:
                    await i.update({ content: 'OpÃ§Ã£o invÃ¡lida.', components: [] });
            }
        });

        // Modal submit handler
        client.on('interactionCreate', async interaction => {
            if (interaction.isModalSubmit()) {
                if (interaction.customId === 'palavra-chave-modal') {

                    try {
                        const palavra = interaction.fields.getTextInputValue('palavra-chave-input');
                        await guild.autoModerationRules.create({
                            name: `${lang.msg66} ${palavra} ${lang.msg67}`,
                            creatorId: client.user.id,
                            enabled: true,
                            eventType: 1,
                            triggerType: 1,
                            triggerMetadata: { keywordFilter: [palavra] },
                            actions: [
                                {
                                    type: 1,
                                    metadata: {
                                        channel: interaction.channel,
                                        durationSeconds: 10,
                                        customMessage: `${lang.msg61}`
                                    }
                                }
                            ]
                        })


                        const embedPalavraChave = new discord.EmbedBuilder()
                            .setColor("#ff0000")
                            .setTitle("ðŸ“‘ AutoMod Ativado: Palavra-Chave")
                            .setDescription(`Palavra bloqueada: ${palavra}`)
                            .addFields({ name: "Administrador", value: interaction.user.tag })
                            .setTimestamp();

                        logChannelLogs.send({ embeds: [embedPalavraChave] });
                        await interaction.reply({ content: 'Palavra bloqueada com sucesso!', ephemeral: true });

                    } catch (error) {

                        return await interaction.reply({ content: `${lang.msg62}`, ephemeral: true });
                    }

                }

                if (interaction.customId === 'mencao-spam-modal') {

                    try {
                        const limiteMencoes = interaction.fields.getTextInputValue('mencao-spam-input');

                        await guild.autoModerationRules.create({
                            name: `${lang.msg65} ${limiteMencoes} ${lang.msg67}`,
                            creatorId: client.user.id,
                            enabled: true,
                            eventType: 1,
                            triggerType: 5,
                            triggerMetadata: { mentionTotalLimit: parseInt(limiteMencoes) },
                            actions: [
                                {
                                    type: 1,
                                    metadata: {
                                        channel: interaction.channel,
                                        durationSeconds: 10,
                                        customMessage: `${lang.msg61}`
                                    }
                                }
                            ]
                        })


                        const embedMencaoSpam = new discord.EmbedBuilder()
                            .setColor("#ff0000")
                            .setTitle("ðŸ“‘ AutoMod Ativado: Limite de MenÃ§Ãµes")
                            .setDescription(`Limite: ${limiteMencoes} menÃ§Ãµes`)
                            .addFields({ name: "Administrador", value: interaction.user.tag })
                            .setTimestamp();

                        logChannelLogs.send({ embeds: [embedMencaoSpam] });
                        await interaction.reply({ content: 'Limite de menÃ§Ãµes configurado com sucesso!', ephemeral: true });
                    } catch (error) {

                        return await interaction.reply({ content: `${lang.msg62}`, ephemeral: true });
                    }

                }

            }
        });

        collector.on('end', collected => {
            if (collected.size === 0) {
                interaction.followUp({
                    content: 'VocÃª nÃ£o fez nenhuma seleÃ§Ã£o a tempo.',
                    ephemeral: true
                });
            }
        });
    }
};
